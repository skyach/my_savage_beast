<% @page_title = "ViewGuide Forum > #{@forum.name} > #{@topic.title}" %>
<% @page_id = "forum" %>
<% content_for :page_stylesheet do -%>
  <%= stylesheet_link_tag 'forum' %>
<% end -%>

<% @monitoring = logged_in? && !Monitorship.where('user_id = ? and topic_id = ? and active = ?', current_user.id, @topic.id, true).count.zero? %>

<% content_for :right do -%>

  <h5><%= t('voices_title') %></h5>
  <ul class="flat talking">
    <% @topic.voices.uniq.each do |user| %>
      <li><%= link_to h(user.display_name), user_path(user) %></li>
    <% end %>
  </ul>


<% end # right content  -%>

<div id="content-left">
  <div class="crumbs">
    <%= link_to t('forums_title'), forums_path %> <span class="arrow">&rarr;</span>
    <%= link_to h(@topic.forum.name), forum_path(@topic.forum) %>
    <%
      page = session[:forum_page] ? session[:forum_page][@topic.forum.id] : nil
      if page and page != 1 %>
      <small style="color:#ccc">
        (<%= link_to t('page', page: page), forum_path(:id => @topic.forum, :page => page) %>)
      </small>
    <% end %>
    <span class="arrow">&rarr;</span>
  </div>

  <% if logged_in? %>
    <% form_tag forum_topic_monitorship_path(@forum, @topic), :style => 'margin-top:0em; float:right;' do -%>
      <div>
        <input id="monitor_checkbox" type="checkbox" <%= "checked='checked'" if @monitoring %>
               onclick="if (this.checked) {<%= remote_function :url => forum_topic_monitorship_path(@forum, @topic) %>} else {<%= remote_function :url => forum_topic_monitorship_path(@forum, @topic), :method => :delete %>}"/>
        <label id="monitor_label" for="monitor_checkbox"><%= @monitoring ? 'Monitoring topic' : 'Monitor topic' %></label>
        <%= hidden_field_tag '_method', 'delete' if @monitoring %>
        <%= submit_tag :Set, :id => 'monitor_submit' %>
      </div>
    <% end -%>

  <% end -%>
  <div style="clear: both;"></div>

  <div id="forum-block" class="bchip">
    <div class="widget-wrap">
      <h2 id="topic-title" class="chip-header" <%= raw %( onmouseover="$('topic_mod').show();" onmouseout="$('topic_mod').hide();") if logged_in? %>>
        <em>
          <%= h @topic.title %>
          <% if @topic.locked? %>
            <span>(<%= 'locked' %>)</span>
          <% end %>
          <% if logged_in? %>
    <span style="display:none;" id="topic_mod">
      <% if @topic.editable_by?(current_user) %>
        <%= link_to('edit', edit_forum_topic_path(@forum, @topic), :class => "utility") %> |
        <%= link_to('delete', forum_topic_path(@forum, @topic), :class => "utility", :method => :delete, :confirm => t('delete_topic_conf')) %>
      <% end %>
    </span>
          <% end %>
        </em>
      </h2>
      <div id="info-widget">
        <%= feed_icon_tag @topic.title, forum_topic_path(@forum, @topic, :format => :rss) %>
        <%= posts_locale(@topic.posts.count) %>,
        <%= voice_locale(@topic.voices.count) %>
      </div>
      <%= will_paginate @posts %>

      <a name="<%= dom_id @posts.first %>" id="<%= dom_id @posts.first %>">&nbsp;</a>
    </div>
    <div class="inner">
      <table border="0" cellspacing="0" cellpadding="0" class="posts wide">
        <% posts_counter = 0 %>
        <% for post in @posts do %>
          <% posts_counter = posts_counter + 1 %>
          <!--
			<%# unless post == @posts.first %>
				<tr class="spacer">
					<td colspan="2">
						<a name="<%#= dom_id post %>" id="<%#= dom_id post %>">&nbsp;</a>
					</td>
				</tr>
			<%# end %>
			-->
          <tr class="post hentry
            <% if posts_counter % 2 == 0 %> stripe
            <% end %>" id="<%= dom_id post %>-row">
            <td class="l-cell author vcard" width="30%">
              <div class="date">
                <a href="#<%= dom_id post %>" rel="bookmark">
                  <abbr class="updated" title="<%= post.created_at.xmlschema %>">
                    <%= time_ago_in_words(post.created_at) %>
                  </abbr>
                </a>
              </div>
              <%#= avatar_for post.user %>

              <span class="fn"><%= link_to truncate(h(post.user.display_name), length: 15), member_path(post.user), :class => (post.user == @posts.first.user ? "threadauthor" : nil) %></span>
              <% if post.user.admin? or post.forum.moderators.include?(post.user) %>
                <span class="admin">
                <% if post.user.admin? %>
                <%= t('administrator_title') %>
                <% elsif post.forum.moderators.include?(post.user) %>
                <%= t('moderator_title') %>
                <% end %>
              </span>
              <% end %>
              <span class="posts"><%= posts_locale(post.user.posts.count) %></span>
              <%= user_profile_pic(post.user, :small) %> <%# NEW AVATAR IMAGE %>
              <% if logged_in? && post.editable_by?(current_user) -%>
                <p>
                  <span class="edit">
                    <%= ajax_spinner_for "edit-post-#{post.id}", "spinner_bounce.gif" %>
                    <%= link_to('Edit post',
                                       edit_post_path(:forum_id => @forum, :topic_id => @topic, :id => post), :method => :get,
                                       :class => "utility", remote: true) %>
                  </span>
                </p>
              <% end -%>
            </td>
            <td class="body entry-content" id="post-body-<%= post.id %>" width="70%">
              <!--
               <%= link_to_function image_tag('my_savage_beast/clearbits/comment.gif', :class => 'icon reply'), "$('reply').toggle()" if logged_in? %>
					-->
              <%= raw post.body_html %>
            </td>
          </tr>
        <% end %>
      </table>
    </div>
    <div class="bottom-cap"></div>
  </div>
  <div class="widget-bot" style="float: right;">
    <%#= next_page @posts %>
    <%= will_paginate @posts %>
  </div>
  <div style="clear: both;"></div>

  <% if logged_in? %>
    <div id="edit"></div>
    <% if @topic.locked? %>
      <p>
        <%= image_tag "my_savage_beast/clearbits/lock.gif", :class => "icon grey", :title => t('topic_locked_title') %>
        <label><%= t('locked_topic') %>.</label>
      </p>
    <% else %>
      <p><%= link_to_function 'Reply to topic', "ReplyForm.init()", :class => "outer utility" %></p>
      <div id="reply" class="editbox">
        <div class="container">
          <%= content_tag 'p', h(flash[:bad_reply]), :class => 'notice' if flash[:bad_reply] %>
          <%= form_for :post, :url => posts_path(:forum_id => @forum, :topic_id => @topic, :page => @topic.last_page) do |f| -%>
            <table width="100%" border="0" cellpadding="0" cellspacing="0">
              <tr>
                <td rowspan="2" width="70%">
                  <%= f.text_area :body, :rows => 8 %>
                </td>
                <td valign="top">


                  <h5><%= 'Formatting Help'%></h5>

                  <ul class="help">
                    <li><%= t('formatting_bold') %>
                      &nbsp; &nbsp; &nbsp;
                      <%= t('formatting_italics') %>
                      &nbsp; &nbsp; &nbsp;<br />
                      <%= t('formatting_blockquote') %></li>
                    <li>"IBM":http://www.ibm.com</li>
                    <li><%= t('formatting_list') %></li>
                  </ul>

                </td>
              </tr>
              <tr>
                <td valign="bottom" style="padding-bottom:15px;">
                  <%= submit_tag "Save Reply" %><span class="button_or">or <%= link_to_function 'cancel', "$('reply').hide()" %></span>
                </td>
              </tr>
            </table>
          <% end -%>
        </div>
      </div>
      <% if params[:reply].nil? %>
        <%= javascript_tag "$('reply').hide();" %>
      <% else %>
        <%= javascript_tag "$('post_body').focus();" %>
      <% end %>
    <% end %>
  <% end %>

  <div class="crumbs" style="margin-top:1.1em;">
    <%= link_to t('forums_title'), forums_path %> <span class="arrow">&rarr;</span>
    <%= link_to h(@topic.forum.name), forum_path(@topic.forum) %> <span class="arrow">&rarr;</span>
  </div>

  <div style="clear: both;"></div>

  <div id="bottom-ads">
    <div class="ad-728-90"><%= ad_chip('forum-1') %></div>
  </div>

</div>

<div id="content-right">
  <div id="side-ad-top" class="ad-160-600"><%= ad_chip('forum-2') %></div>
  <div class="ad-160-600"><%= ad_chip('forum-3') %></div>
</div>
